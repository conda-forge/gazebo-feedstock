From d03f8b756fbca220f2abbcc6e62e877598024e0a Mon Sep 17 00:00:00 2001
From: Silvio Traversaro <silvio@traversaro.it>
Date: Fri, 5 Sep 2025 13:18:54 +0200
Subject: [PATCH] Fix build with ffmpeg8

---
 gazebo/common/AudioDecoder.cc | 6 ++++++
 gazebo/common/Video.cc        | 4 ++++
 2 files changed, 10 insertions(+)

diff --git a/gazebo/common/AudioDecoder.cc b/gazebo/common/AudioDecoder.cc
index 18ca3b5dd2..3e1ae94b43 100644
--- a/gazebo/common/AudioDecoder.cc
+++ b/gazebo/common/AudioDecoder.cc
@@ -47,7 +47,13 @@ void AudioDecoder::Cleanup()
 #ifdef HAVE_FFMPEG
   // Close the codec
   if (this->codecCtx)
+  {
+#if LIBAVFORMAT_VERSION_MAJOR < 59
     avcodec_close(this->codecCtx);
+#else
+    avcodec_free_context(&this->codecCtx);
+#endif
+  }
 
   // Close the audio file
   if (this->formatCtx)
diff --git a/gazebo/common/Video.cc b/gazebo/common/Video.cc
index e4f97a8b83..c3febbcc68 100644
--- a/gazebo/common/Video.cc
+++ b/gazebo/common/Video.cc
@@ -114,7 +114,11 @@ void Video::Cleanup()
   avformat_close_input(&this->formatCtx);
 
   // Close the codec
+#if LIBAVCODEC_VERSION_INT >= AV_VERSION_INT(57, 48, 101)
+  avcodec_free_context(&this->codecCtx);
+#else
   avcodec_close(this->codecCtx);
+#endif
 
   av_free(this->avFrameDst);
 #endif
